<?xml version="1.0"?>
<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <PropertyGroup>
    <MSBuildAllProjects>$(MSBuildAllProjects);$(MSBuildThisFileFullPath)</MSBuildAllProjects>
    <!-- We allow a non-C# generator be set by the user, but skip adding outputs to Compile in this case. -->
    <Protobuf_Generator Condition=" '$(Protobuf_Generator)' == '' and '$(Language)' == 'C#' ">CSharp</Protobuf_Generator>
    <!-- Configuration is passing the smoke test. -->
    <Protobuf_ProjectSupported Condition=" '$(Protobuf_Generator)' != '' ">true</Protobuf_ProjectSupported>
    <_Protobuf_MsBuildAssembly>netstandard2.0\sRPC.Tools.dll</_Protobuf_MsBuildAssembly>
  </PropertyGroup>

  <UsingTask AssemblyFile="$(_Protobuf_MsBuildAssembly)"
             TaskName="sRPC.Tools.ProtoGenerate" />
  <UsingTask AssemblyFile="$(_Protobuf_MsBuildAssembly)"
             TaskName="sRPC.Tools.ProtoPlatform" />

  <ItemGroup Condition=" '$(Protobuf_ProjectSupported)' == 'true' and '$(Language)' == 'C#' ">
    <!-- Extend property pages with gRPC properties. -->
    <PropertyPageSchema Include="$(MSBuildThisFileDirectory)sRPC.CSharp.xml">
      <Context>File;BrowseObject</Context>
    </PropertyPageSchema>
    <AvailableItemName Include="Protobuf" />
  </ItemGroup>

  <ItemDefinitionGroup>
    <Protobuf>
      <Access Condition=" '%(Protobuf.Access)' == '' ">Public</Access>
      <NamespaceBase Condition=" '%(Protobuf.NamespaceBase)' == ''">$(TargetName)</NamespaceBase>
      <SrpcExt Condition=" '%(Protobuf.SrpcExt)' == ''">.service.cs</SrpcExt>
      <ProtoExt Condition=" '%(Protobuf.ProtoExt)' == ''">.g.cs</ProtoExt>

      <ProtoCompile Condition="'%(Protobuf.ProtoCompile)' == '' ">True</ProtoCompile>
      <ProtoRoot Condition="'%(Protobuf.ProtoRoot)' == '' " />
      <Generator Condition="'%(Protobuf.Generator)' == '' and '$(DisableProtobufDesignTimeBuild)' != 'true' " >MSBuild:Compile</Generator>
    </Protobuf>
  </ItemDefinitionGroup>

  <PropertyGroup>
    <!-- NET SDK: by default, do not include proto files in the directory.
         Current Microsoft's recommendation is against globbing:
         https://docs.microsoft.com/en-us/dotnet/core/tools/csproj#recommendation -->
    <EnableDefaultProtobufItems Condition=" '$(EnableDefaultProtobufItems)' == '' ">false</EnableDefaultProtobufItems>
  </PropertyGroup>

  <!-- Check configuration sanity before build. -->
  <Target Name="_Protobuf_SanityCheck" BeforeTargets="PrepareForBuild">
    <Error
      Condition=" '$(Protobuf_ProjectSupported)' != 'true' "
      Text="sRPC.Tools proto compilation is only supported by default in a C# project (extension .csproj)" />
  </Target>

  <Target Name="Protobuf_ResolvePlatform">
    <Message Text="Resolve Platform" />
    <ProtoPlatform>
      <Output TaskParameter="Os" PropertyName="_Protobuf_ToolsOs"/>
      <Output TaskParameter="Cpu" PropertyName="_Protobuf_ToolsCpu"/>
    </ProtoPlatform>

    <PropertyGroup>
      <!-- First try environment variable. -->
      <Protobuf_ToolsOs Condition=" '$(Protobuf_ToolsOs)' == '' ">$(PROTOBUF_TOOLS_OS)</Protobuf_ToolsOs>
      <Protobuf_ToolsCpu Condition=" '$(Protobuf_ToolsCpu)' == '' ">$(PROTOBUF_TOOLS_CPU)</Protobuf_ToolsCpu>
      <Protobuf_ProtocFullPath Condition=" '$(Protobuf_ProtocFullPath)' == '' ">$(PROTOBUF_PROTOC)</Protobuf_ProtocFullPath>
      <Protobuf_SrpcFullPath Condition=" '$(Protobuf_SrpcFullPath)' == '' ">$(PROTOBUF_SRPC)</Protobuf_SrpcFullPath>

      <!-- Next try OS and CPU resolved by ProtoPlatform. -->
      <Protobuf_ToolsOs Condition=" '$(Protobuf_ToolsOs)' == '' ">$(_Protobuf_ToolsOs)</Protobuf_ToolsOs>
      <Protobuf_ToolsCpu Condition=" '$(Protobuf_ToolsCpu)' == '' ">$(_Protobuf_ToolsCpu)</Protobuf_ToolsCpu>
      <Protobuf_ProtocFullPath Condition=" '$(Protobuf_ProtocFullPath)' == '' and '$(Protobuf_ToolsOs)' == 'windows' "
           >$(Protobuf_PackagedToolsPath)\$(Protobuf_ToolsOs)_$(Protobuf_ToolsCpu)\protoc.exe</Protobuf_ProtocFullPath>
      <Protobuf_ProtocFullPath Condition=" '$(Protobuf_ProtocFullPath)' == '' "
           >$(Protobuf_PackagedToolsPath)/$(Protobuf_ToolsOs)_$(Protobuf_ToolsCpu)/protoc</Protobuf_ProtocFullPath>
      <Protobuf_SrpcFullPath Condition=" '$(Protobuf_SrpcFullPath)' == '' and '$(Protobuf_ToolsOs)' == 'windows' "
           >$(Protobuf_PackagedToolsPath)/sRPCgen.exe</Protobuf_SrpcFullPath>
      <Protobuf_SrpcFullPath Condition=" '(Protobuf_SrpcFullPath)' == '' "
           >$(Protobuf_PackagedToolsPath)/sRPCgen</Protobuf_SrpcFullPath>
      
    </PropertyGroup>

    <Error Condition=" '$(DisableProtobufDesignTimeBuild)' != 'true' and '$(PROTOBUF_PROTOC)' == ''
                        and ( '$(Protobuf_ToolsOs)' == '' or '$(Protobuf_ToolsCpu)' == '' ) "
      Text="sRPC.Tools cannot determine host OS and CPU.&#10;Use environment variables PROTOBUF_TOOLS_OS={linux|macosx|windows} and PROTOBUF_TOOLS_CPU={x86|x64} to try the closest match to your system.&#10;You may also set PROTOBUF_PROTOC to specify full path to the host-provided compiler (v3.5+ is required)." />
  </Target>

  <Target Name="srpc_Generate"
          Condition=" '@(Protobuf)' != '' "
          DependsOnTargets=" Protobuf_ResolvePlatform ">
    <Message Text="Generate SRPC" />
    <ProtoGenerate
      Protobuf="@(Protobuf)"
      SrpcGenPath="$(Protobuf_SrpcFullPath)"
      ProtocPath="$(Protobuf_ProtocFullPath)"
      ProjectPath="$(ProjectDir)"
      />
  </Target>

  <Target Name="Srpc_Build"
          DependsOnTargets="Protobuf_ResolvePlatform; srpc_Generate" />

  <Target Name="_Srpc_Compile_BeforeCsCompile"
          BeforeTargets="PreBuildEvent"
          DependsOnTargets="Srpc_Build"
          Condition=" '$(Language)' == 'C#' " />

</Project>
